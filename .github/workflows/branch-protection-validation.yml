name: Branch Protection Validation

on:
  push:
    branches: [ main ]
    paths:
      - 'scripts/configure-branch-protection.js'
      - 'scripts/branch-protection-config.json'
      - '.github/workflows/**'
  pull_request:
    branches: [ main ]
    paths:
      - 'scripts/configure-branch-protection.js'
      - 'scripts/branch-protection-config.json'
      - '.github/workflows/**'

jobs:
  validate-branch-protection:
    name: Validate Branch Protection Configuration
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci --legacy-peer-deps
        
      - name: Validate branch protection script
        run: |
          echo "üîç Validating branch protection configuration script..."
          
          # Check if script exists and is executable
          if [ ! -f "scripts/configure-branch-protection.js" ]; then
            echo "‚ùå Branch protection script not found"
            exit 1
          fi
          
          # Check if configuration file exists
          if [ ! -f "scripts/branch-protection-config.json" ]; then
            echo "‚ùå Branch protection configuration file not found"
            exit 1
          fi
          
          # Validate JSON configuration
          if ! node -e "JSON.parse(require('fs').readFileSync('scripts/branch-protection-config.json', 'utf8'))"; then
            echo "‚ùå Invalid JSON in branch protection configuration"
            exit 1
          fi
          
          echo "‚úÖ Branch protection configuration files are valid"
          
      - name: Test script functionality
        run: |
          echo "üß™ Testing branch protection script functionality..."
          
          # The script should fail gracefully when GitHub CLI is not authenticated
          # This is expected behavior for the test environment
          if node scripts/configure-branch-protection.js 2>&1 | grep -q "GitHub CLI is not authenticated"; then
            echo "‚úÖ Script correctly handles unauthenticated state"
          else
            echo "‚ùå Script did not handle unauthenticated state properly"
            exit 1
          fi
          
      - name: Validate required status checks
        run: |
          echo "üìã Validating required status checks configuration..."
          
          # Extract status checks from configuration
          STATUS_CHECKS=$(node -e "
            const config = JSON.parse(require('fs').readFileSync('scripts/branch-protection-config.json', 'utf8'));
            console.log(JSON.stringify(config.required_status_checks.contexts, null, 2));
          ")
          
          echo "Required status checks:"
          echo "$STATUS_CHECKS"
          
          # Verify that all expected checks are present
          EXPECTED_CHECKS=(
            "build_and_deploy_job"
            "typescript-check" 
            "lint-check"
            "test-check"
            "build-check"
            "security-check"
          )
          
          for check in "${EXPECTED_CHECKS[@]}"; do
            if echo "$STATUS_CHECKS" | grep -q "\"$check\""; then
              echo "‚úÖ $check - configured"
            else
              echo "‚ùå $check - missing from configuration"
              exit 1
            fi
          done
          
          echo "‚úÖ All required status checks are properly configured"
          
      - name: Validate workflow files
        run: |
          echo "üîß Validating GitHub Actions workflow files..."
          
          # Check if code quality workflow exists
          if [ ! -f ".github/workflows/code-quality.yml" ]; then
            echo "‚ùå Code quality workflow not found"
            exit 1
          fi
          
          # Validate YAML syntax
          if ! node -e "require('yaml').parse(require('fs').readFileSync('.github/workflows/code-quality.yml', 'utf8'))" 2>/dev/null; then
            echo "‚ö†Ô∏è  YAML validation requires yaml package (not critical for validation)"
          fi
          
          # Check if workflow contains required jobs
          REQUIRED_JOBS=(
            "typescript-check"
            "lint-check" 
            "test-check"
            "build-check"
            "security-check"
          )
          
          for job in "${REQUIRED_JOBS[@]}"; do
            if grep -q "^  $job:" ".github/workflows/code-quality.yml"; then
              echo "‚úÖ $job job - defined"
            else
              echo "‚ùå $job job - missing from workflow"
              exit 1
            fi
          done
          
          echo "‚úÖ All required workflow jobs are properly defined"
          
      - name: Generate validation report
        run: |
          echo "üìä Branch Protection Validation Report"
          echo "====================================="
          echo ""
          echo "‚úÖ Branch protection script validation: PASSED"
          echo "‚úÖ Configuration file validation: PASSED" 
          echo "‚úÖ Required status checks: PASSED"
          echo "‚úÖ GitHub Actions workflows: PASSED"
          echo ""
          echo "üéâ All branch protection components are properly configured!"
          echo ""
          echo "Next steps:"
          echo "1. Ensure GitHub CLI is installed and authenticated"
          echo "2. Run 'npm run setup-branch-protection' to apply the rules"
          echo "3. Verify the rules are active in GitHub repository settings"